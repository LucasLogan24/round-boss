<!DOCTYPE html>
<html>
<head>
  <title>Customer Database</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div id="navbar"></div> <!-- âœ… Correct placement -->
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
    <h1 class="text-2xl font-bold mb-4">Customer Database</h1>

    <!-- Search -->
    <input 
      type="text" 
      id="search" 
      placeholder="Search by name, address, or phone..." 
      class="w-full border border-gray-300 p-2 rounded mb-4"
    />

    <!-- Filters -->
    <div class="flex items-center gap-4 mb-4">
      <button id="filter-negative" class="bg-red-100 text-red-800 px-3 py-1 rounded hover:bg-red-200">
        Show Negative Balances
      </button>
      <button id="sort-balance" class="bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200">
        Sort by Balance: Off
      </button>
    </div>

    <div id="filterInfo" class="text-sm mb-4 text-gray-600"></div>

    <!-- Customer List -->
    <div id="customer-table" class="space-y-3 text-sm"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const supabaseUrl = 'https://xntdxtuinufkksopjytc.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhudGR4dHVpbnVma2tzb3BqeXRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNzY5NzksImV4cCI6MjA2ODc1Mjk3OX0.p0uw875QyOhwrORXz0tecqJIU3pH6Um2cH9zAzk62-o'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const tableEl = document.getElementById('customer-table')
    const searchInput = document.getElementById('search')
    const filterBtn = document.getElementById('filter-negative')
    const sortBtn = document.getElementById('sort-balance')

    let allCustomers = []
    let showNegativeOnly = false
    let sortBalance = false

    async function loadCustomers() {
      const { data, error } = await supabase
        .from('customers')
        .select('*')
        .order('created_at', { ascending: false })

      if (error) {
        tableEl.innerHTML = `<p class="text-red-500">Error loading customers.</p>`
      } else {
        allCustomers = data
        displayCustomers()
      }
    }

    function displayCustomers() {
      const search = searchInput.value.toLowerCase()

      let filtered = allCustomers.filter(c =>
        c.customer_name?.toLowerCase().includes(search) ||
        c.address?.toLowerCase().includes(search) ||
        c.phone_number?.includes(search)
      )

      if (showNegativeOnly) {
        filtered = filtered.filter(c => parseFloat(c.balance) < 0)
      }

      if (sortBalance) {
        filtered = filtered.sort((a, b) => (a.balance ?? 0) - (b.balance ?? 0))
      }

      tableEl.innerHTML = filtered.map(c => `
        <div class="p-4 bg-gray-100 rounded shadow-sm relative">
          <div class="flex justify-between">
            <strong>${c.customer_name}</strong>
            <div>
              <button 
                onclick="deleteCustomer('${c.id}')" 
                class="text-red-600 text-xs bg-red-100 px-2 py-1 rounded hover:bg-red-200 mr-1">
                Delete
              </button>
              <button 
                onclick="toggleEdit('${c.id}')" 
                class="text-blue-600 text-xs bg-blue-100 px-2 py-1 rounded hover:bg-blue-200">
                Edit
              </button>
            </div>
          </div>
          <div>
            ${c.address}<br>
            ðŸ“ž ${c.phone_number} | ðŸ’¬ ${c.notes || 'â€”'} | ðŸ’° Â£${(c.balance ?? 0).toFixed(2)}
          </div>

          <div id="edit-form-${c.id}" class="mt-4 space-y-2 hidden">
            <input id="edit-name-${c.id}" value="${c.customer_name}" class="w-full border p-1 rounded" />
            <input id="edit-address-${c.id}" value="${c.address}" class="w-full border p-1 rounded" />
            <input id="edit-phone-${c.id}" value="${c.phone_number}" class="w-full border p-1 rounded" />
            <input id="edit-notes-${c.id}" value="${c.notes || ''}" class="w-full border p-1 rounded" />
            <input id="edit-balance-${c.id}" value="${c.balance}" type="number" class="w-full border p-1 rounded" />
            <button onclick="saveEdit('${c.id}')" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
              Save
            </button>
          </div>
        </div>
      `).join('')
    }

    searchInput.addEventListener('input', displayCustomers)

    filterBtn.addEventListener('click', () => {
      showNegativeOnly = !showNegativeOnly
      filterBtn.textContent = showNegativeOnly ? "Show All Customers" : "Show Negative Balances"
      displayCustomers()
    })

    sortBtn.addEventListener('click', () => {
      sortBalance = !sortBalance
      sortBtn.textContent = sortBalance ? "Sort by Balance: On" : "Sort by Balance: Off"
      displayCustomers()
    })

    window.deleteCustomer = async function(id) {
      if (!confirm("Are you sure you want to delete this customer?")) return

      const { error } = await supabase.from('customers').delete().eq('id', id)

      if (error) {
        alert("Failed to delete customer.")
        console.error(error)
      } else {
        loadCustomers()
      }
    }

    window.toggleEdit = function(id) {
      const form = document.getElementById(`edit-form-${id}`)
      form.classList.toggle('hidden')
    }

    window.saveEdit = async function(id) {
      const name = document.getElementById(`edit-name-${id}`).value
      const address = document.getElementById(`edit-address-${id}`).value
      const phone = document.getElementById(`edit-phone-${id}`).value
      const notes = document.getElementById(`edit-notes-${id}`).value
      const balance = parseFloat(document.getElementById(`edit-balance-${id}`).value)

      const { error } = await supabase
        .from('customers')
        .update({ customer_name: name, address, phone_number: phone, notes, balance })
        .eq('id', id)

      if (error) {
        alert("Failed to update customer.")
        console.error(error)
      } else {
        loadCustomers()
      }
    }

    loadCustomers()
  </script>

  <!-- âœ… This loads the reusable navbar -->
  <script type="module" src="navbar.js"></script>
</body>
</html>